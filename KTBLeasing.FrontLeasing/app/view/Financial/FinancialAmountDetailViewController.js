/*
 * File: app/view/Financial/FinancialAmountDetailViewController.js
 *
 * This file was generated by Sencha Architect version 3.2.0.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('TabUserInformation.view.Financial.FinancialAmountDetailViewController', {
    extend: 'Ext.app.ViewController',
    alias: 'controller.financialfinancialamountdetail',

    onComboboxMainAssetChange: function (field, newValue, oldValue, eOpts) {
        var form = this.getView().down('#formMain').getForm(),
            combo = form.findField('MainAsset'),
            storeSub = form.findField('SubAsset').getStore(),
            storeDetail = form.findField('DetailAsset').getStore(),
            storeMarketable = form.findField('Marketable').getStore();

        storeSub.clearFilter();
        storeSub.filterBy(function (item) {
            if (oldValue) {
                form.findField('SubAsset').setValue(null);
                form.findField('DetailAsset').setValue(null);
                form.findField('Marketable').setValue(null);
            }

            return item.get('Parent_Id') == combo.getValue() & item.get('Id') != item.get('Parent_Id');
        });

        storeDetail.clearFilter();
        storeDetail.filterBy(function (item) {
            return item.get('Parent_Id') == combo.getValue() & item.get('Id') != item.get('Parent_Id') & item.get('Id').toString().length > 2;
        });

        if (combo.getValue() === 1 || combo.getValue() === 5) {
            form.findField('Marketable').enable();
            form.findField('Marketable').allowBlank = false;
        } else {
            form.findField('Marketable').disable();
            form.findField('Marketable').allowBlank = true;
        }
    },

    onComboboxSubAssetChange: function (field, newValue, oldValue, eOpts) {
        var form = this.getView().down('#formMain').getForm(),
            combo = form.findField('SubAsset'),
            store = form.findField('DetailAsset').getStore();

        if (form.findField('MainAsset').getValue() === 9) {
            store.clearFilter();
            store.filterBy(function (item) {
                if (oldValue) {
                    form.findField('DetailAsset').setValue(null);
                    form.findField('Marketable').setValue(null);
                }

                return item.get('Parent_Id') == combo.getValue();
            });
        }
    },

    onStoreSubAssetsFilterChange: function (store, filters, eOpts) {
        var form = this.getView().down('#formMain').getForm();

        if (store.data.length > 0 || form.findField('SubAsset').getValue() > 0) {
            form.findField('SubAsset').enable();
            form.findField('SubAsset').allowBlank = false;
        } else {
            form.findField('SubAsset').disable();
            form.findField('SubAsset').allowBlank = true;
        }
    },

    onStoreDetailAssetsFilterChange: function (store, filters, eOpts) {
        var form = this.getView().down('#formMain').getForm();

        if (store.data.length > 0 || form.findField('DetailAsset').getValue() > 0) {
            form.findField('DetailAsset').enable();
            form.findField('DetailAsset').allowBlank = false;
        } else {
            form.findField('DetailAsset').disable();
            form.findField('DetailAsset').allowBlank = true;
        }
    },

    onComboboxMethodPaymentSelect: function (combo, record, eOpts) {
        var form = this.getView().down('#formMain').getForm();

        if (combo.getValue() === 204) {
            form.findField('ChequeCondition').show();
            form.findField('ChequeCondition').allowBlank = false;
        } else {
            form.findField('ChequeCondition').setValue(null);
            form.findField('ChequeCondition').hide();
            form.findField('ChequeCondition').allowBlank = true;
        }
    },

    onButtonSaveClick: function (button, e, eOpts) {
        var me = this,
            view = me.getView(),
            form = view.down('form').getForm(),
            record = form.getRecord();

        Ext.MessageBox.confirm('Confirm', 'Confirm Save?', function (msg) {
            if (msg === 'yes') {
                record.phantom = false;

                form.updateRecord(record);

//                if (form.isValid()) {
//                    form.findField('save').setValue('Y');
//                    view.close();
//                }
                TabUserInformation.controller.WindowController.fnSaveChildSession(view);
            }
        });
    },

    onButtonGuarantorAddClick: function (button, e, eOpts) {
        var me = this,
            store = me.getViewModel().getStore('guarantorModels'),
            formMain = this.getView().down('#formMain').getForm(),
            Id = formMain.findField('Id').getValue(),
            record = Ext.create('model.guarantormodel', {
                CreditLimitId: Id
            });

        if (Id > 0) {
            Ext.Msg.show({
                title: 'Select Guarantor',
                msg: 'Create New Guarantor or Old Guarantor',
                buttons: Ext.MessageBox.YESNOCANCEL,
                buttonText: { yes: 'New Guarantor', no: 'Old Guarantor', cancel: 'Cancel' },
                width: 350,
                icon: Ext.MessageBox.INFO,
                fn: function (btn) {
                    if (btn === 'yes') {
                        Ext.create('widget.guarantorguarantorswindow', {
                            listeners: {
                                afterrender: function (panel, eOpts) {
                                    var form = panel.down('form').getForm();

                                    panel.down('#MasterPage').setValue(me.getView().getId());

                                    store.add(record);

                                    form.loadRecord(record);
                                }
                            }
                        }).show();
                    } else if (btn === 'no') {
                        Ext.create('widget.popupcusinfpopup', {
                            listeners: {
                                afterrender: function (panel, e0pst) {
                                    panel.down('#MasterPage').setValue(me.getView().getId());
                                }
                            }
                        }).show();
                    }
                }
            });
        } else {
            Ext.Msg.show({
                title: 'Warning',
                message: 'กรุณาทำการบันทึกข้อมูลหน้าหลักก่อน',
                buttons: Ext.Msg.OK,
                icon: Ext.Msg.WARNING
            });
        }
    },

    onGridpanelGuarantorItemDblClick: function (dataview, record, item, index, e, eOpts) {
        var me = this;

        Ext.create('widget.guarantorguarantorswindow', {
            listeners: {
                afterrender: function (panel, eOpts) {
                    var form = panel.down('form').getForm();

                    panel.down('#MasterPage').setValue(me.getView().getId());

                    form.loadRecord(record);
                }
            }
        }).show();
    },

    onButtonDeleteClick: function (button, e, eOpts) {
        var grid = button.up('grid'),
            store = grid.getStore(),
            selected = grid.getSelection();

        if (selected.length > 0) {
            Ext.MessageBox.confirm({
                title: 'Delete?',
                message: 'คุณต้องการลบรายการนี้ใช่หรือไม่?',
                buttons: Ext.Msg.YESNO,
                icon: Ext.Msg.QUESTION,
                fn: function (btn) {
                    if (btn === 'yes') {
                        selected[0].set('Active', false);
                        store.remove(selected[0]);
                    }
                }
            });
        } else {
            Ext.Msg.show({
                title: 'Warning',
                message: 'กรุณาทำการเลือกรายการที่ต้องการลบ',
                buttons: Ext.Msg.OK,
                icon: Ext.Msg.WARNING
            });
        }
    },

    onBeforeClose: function(panel, eOpts) {
        var me = this,
            view = me.getView(),
            form = panel.down('form').getForm(),
            record = form.getRecord();

        if (panel.closeMe) {
            panel.closeMe = false;
            return true;
        }
        
        if(form.isDirty()) {
            if (form.findField('save').getValue() === 'N') {
                Ext.Msg.show({
                    title: 'Save',
                    message: 'Save Changes?',
                    buttons: Ext.Msg.YESNOCANCEL,
                    icon: Ext.Msg.QUESTION,
                    width: 300,
                    fn: function (btn) {
                        if (btn === 'yes') {
                            Ext.MessageBox.show({
                                title: 'Please wait',
                                msg: 'Saving items...',
                                progressText: 'Saving...',
                                width: 300,
                                progress: true,
                                closable: false,
                            });

                            record.phantom = false;

                            TabUserInformation.controller.WindowController.fnSaveChildSession(view);

                        } else if (btn === 'no') {
                            if(record.phantom) // phantom true = not exist server-side
                            {
                                record.phantom = false;
                                record.set('Active', false);
                                record.drop();
                                record.save();
                            }
                            panel.closeMe = true;
                            panel.close();
                        }
                    }
                });
            }else {
                panel.closeMe = true;
                panel.close();
            }
        } else {
            if(record.phantom) // phantom true = not exist server-side
            {
                record.phantom = false;
                record.set('Active', false);
                record.drop();
                record.save();
            }
            panel.closeMe = true;
            panel.close();
        }

        return false;
    },

    onClose: function(panel, eOpts) {
        var store = Ext.getCmp(this.getView().down('#MasterPage').getValue()).getViewModel().getStore('creditLimitDetails');
        //store.rejectChanges();
    }

});
